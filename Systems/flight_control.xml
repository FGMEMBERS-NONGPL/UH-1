<?xml version="1.0"?>

<!--
**************************************************************************

Copyright (c) 2020 Simon 'bomber' Morley
simonbomber64 at googlemail.com

This work is licensed under the
Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License.
To view a copy of this license,
visit http://creativecommons.org/licenses/by-nc-sa/3.0/ or
send a letter to Creative Commons, PO Box 1866, Mountain View, CA 94042, USA.

Attribution,  You must give appropriate credit, provide a link to the license,
and indicate if changes were made. You may do so in any reasonable manner,
but not in any way that suggests the licensor endorses you or your use.

NonCommercial,  You may not use the material for commercial purposes.

ShareAlike,  If you remix, transform, or build upon the material,
you must distribute your contributions under the same license as the original.

**************************************************************************
Vectors along the axis
x = u
y = v
z = w
Rotation around the axis
x = p
y = q
z = r
Moments around the axis
x = l
y = m
z = n
-->

<system name="flight_control">

<property type="double" value="1">fcs/collective-cmd-norm</property>
<property type="double" value="0">T4T/AGP/PID/collective/cmd-norm</property>
<property type="double" value="2">T4T/AGP/mode</property>
<property type="double" value="0">T4T/AGP/trim</property>

<channel name="Flight Mode">

		<switch name="T4T/AGP/mode-1">
			<default value="0"/>
			<test value="1">
				T4T/AGP/mode eq 1
			</test>
			<output>T4T/AGP/mode-1</output>
		</switch>

		<switch name="T4T/AGP/mode-2">
			<default value="0"/>
			<test logic="AND" value="1">
				T4T/AGP/mode eq 2
				/sim/current-view/view-number ne 9	
			</test>
			<output>T4T/AGP/mode-2</output>
		</switch>
		
		<switch name="T4T/AGP/mode-3">
			<default value="0"/>
			<test logic="AND" value="1">
				T4T/AGP/mode eq 2
				/sim/current-view/view-number eq 9	
			</test>
			<output>T4T/AGP/mode-3</output>
		</switch>

		<switch name="T4T/AGP/mode-4">
			<default value="0"/>
			<test logic="AND" value="1">
				gear/wow ne 1
				propulsion/engine[0]/set-running eq 0	
			</test>
			<output>T4T/AGP/mode-4</output>
		</switch>		
			
</channel>

<channel name="Pilot" execute="T4T/AGP/mode-2">
				
	<!-- Roll Adjust -->
	
		<scheduled_gain>
			<input>T4T/one</input>
			<table>
				<independentVar>fcs/aileron-cmd-norm</independentVar>
				<tableData>
					-1		-1
					1		1
				</tableData>
			</table>
			<output>T4T/AGP/PID/cyclic/roll_adjust</output>
		</scheduled_gain>		
		
	<!-- Pitch Adjust -->
	
		<scheduled_gain>
			<input>T4T/one</input>
			<table>
				<independentVar>fcs/elevator-cmd-norm</independentVar>
				<tableData>
					-1		-1
					1		1
				</tableData>
			</table>
			<output>T4T/AGP/PID/cyclic/pitch_adjust</output>
		</scheduled_gain>		

	<!-- Yaw Adjust -->

		<scheduled_gain>
			<input>T4T/one</input>
			<table>
				<independentVar>fcs/rudder-cmd-norm</independentVar>
				<tableData>
					-1		0.7
					-0.1	1.0
					0.1		1.0
					1		1.3
				</tableData>
			</table>
			<output>propulsion/rotor_rudder_adjust</output>
		</scheduled_gain>
		
	<!--  -->
	
		<fcs_function name="attitude/heading-true-deg">
			<function>
				<todegrees>
					<property>attitude/heading-true-rad</property>
				</todegrees>
			</function>
		</fcs_function>
		
		<summer name="T4T/AGP/PID/alt/h-agl-ft">
			<input></input>
			<input>position/h-agl-ft</input>
		</summer>	

</channel>

<channel name="Auto" execute="T4T/AGP/mode-3">

	<!-- Collective Adjust -->

		<summer>
			<input>propulsion/engine[0]/n1</input>		
			<bias>-100</bias>
			<output>T4T/AGP/PID/n1-pct/error</output>
		</summer>
		<pid>
			<input>-T4T/AGP/PID/n1-pct/error</input>
			<kp>0.001</kp>
			<ki>0</ki>
			<kd>0.001</kd>
			<output>T4T/AGP/PID/n1-pct/adjust</output>
		</pid>

		<summer>
			<input>T4T/AGP/PID/collective/cmd-norm</input>
			<input>T4T/AGP/PID/n1-pct/adjust</input>
			<clipto>											
				<min>-1</min>									
				<max>1</max>									
			</clipto>
			<output>T4T/AGP/PID/collective/cmd-norm</output>			
		</summer>		
				
	<!-- Roll Adjust -->
		
		<fcs_function name="T4T/AGP/PID/heading/true-deg">
			<function>
				<todegrees>
					<property>attitude/heading-true-rad</property>
				</todegrees>
			</function>
		</fcs_function>		
		<summer>
			<input>attitude/heading-true-deg</input>
			<input>-T4T/AGP/PID/heading/true-deg</input>
			<output>T4T/AGP/PID/heading/error_deg</output>
		</summer>
		<pid name="T4T/AGP/PID/heading/adjust">
			<input>T4T/AGP/PID/heading/error_deg</input>
			<kp>0.05</kp>
			<ki>0</ki>
			<kd>0.05</kd>
			<output>T4T/AGP/PID/heading/adjust</output>
		</pid>
		<scheduled_gain>
			<input>T4T/AGP/PID/heading/adjust</input>
			<table>
				<independentVar>velocities/u-aero-fps</independentVar>
				<tableData>
					0		0
					20		1
				</tableData>
			</table>
			<output>T4T/AGP/PID/cyclic/roll_adjust</output>
		</scheduled_gain>		
		
	<!-- Pitch Adjust -->
	
		<summer>
			<input>T4T/AGP/PID/alt/h-agl-ft</input>
			<input>-position/h-agl-ft</input>
			<output>T4T/AGP/PID/alt/error_ft</output>
		</summer>
		<scheduled_gain>
			<input>T4T/one</input>
			<table>
				<independentVar>position/h-agl-ft</independentVar>
				<tableData>
					100			0.001
					1000		0.0001
				</tableData>
			</table>
			<output>T4T/AGP/PID/alt/kpkd</output>
		</scheduled_gain>				
		<pid name="T4T/AGP/PID/alt/adjust">
			<input>-T4T/AGP/PID/alt/error_ft</input>
			<kp>T4T/AGP/PID/alt/kpkd</kp>
			<ki>0</ki>
			<kd>T4T/AGP/PID/alt/kpkd</kd>
			<output>T4T/AGP/PID/cyclic/pitch_adjust</output>
		</pid>		

	<!-- Yaw Adjust -->

		<scheduled_gain>
			<input>T4T/AGP/PID/heading/adjust</input>
			<table>
				<independentVar>velocities/u-aero-fps</independentVar>
				<tableData>
					0		-0.1
					20		0
				</tableData>
			</table>
			<output>T4T/AGP/PID/rudder/yaw_adjust</output>
		</scheduled_gain>
		<summer>
			<input>propulsion/rotor_rudder_adjust</input>
			<input>-T4T/AGP/PID/rudder/yaw_adjust</input>
			<output>propulsion/rotor_rudder_adjust</output>
		</summer>		

</channel>

<channel name="Flight">

	<!-- Collective Adjust -->
	
		<switch name="fcs/collective-cmd-pos">
			<default value="T4T/AGP/PID/collective/cmd-norm"/>
			<test value="fcs/collective-cmd-norm">
				T4T/AGP/mode-2 eq 1
			</test>
			<output>fcs/collective-cmd-pos</output>
		</switch>	

		<scheduled_gain>
			<input>T4T/one</input>
			<table>
				<independentVar>fcs/collective-cmd-pos</independentVar>
				<tableData>
					-1.0	-5
					-0.6	-5
					0.6		5.5
				</tableData>
			</table>
			<output>propulsion/engine[0]/blade-angle</output>			
		</scheduled_gain>
		
		<scheduled_gain>
			<input>T4T/one</input>
			<table>
				<independentVar>propulsion/engine[0]/blade-angle</independentVar>
				<tableData>
					-5		0.72
					5.5		1.00
				</tableData>
			</table>
			<output>propulsion/engine[0]/governor/mech_link</output>
		</scheduled_gain>		
		
	<!-- Roll Adjust -->
	
		<summer>
			<input>T4T/AGP/PID/cyclic/roll_adjust</input>
			<input>T4T/AGP/PID/cyclic/roll_trim-hold</input>
			<clipto>											
				<min>-1</min>									
				<max>1</max>									
			</clipto>
			<output>T4T/AGP/PID/cyclic/roll_target</output>														
		</summer>
		
		<switch name="T4T/AGP/PID/cyclic/roll_trim-hold">
			<default value="T4T/AGP/PID/cyclic/roll_trim-hold"/>
			<test value="T4T/AGP/PID/cyclic/roll_target">
				T4T/AGP/trim eq 1
			</test>
		</switch>		

		<scheduled_gain>
			<input>T4T/one</input>
			<table>
				<independentVar>T4T/AGP/PID/cyclic/roll_target</independentVar>
				<tableData>
					-1		30
					1		-30
				</tableData>
			</table>
			<output>external_reactions/rotor_main/cyclic_roll-in</output>
		</scheduled_gain>
		
		<scheduled_gain>
			<input>T4T/one</input>
			<table>
				<independentVar>T4T/AGP/PID/cyclic/roll_target</independentVar>
				<tableData>
					-30		0.2618 	<!-- 15 degs -->
					30		-0.2618	<!-- -15 degs -->
				</tableData>
			</table>
			<output>propulsion/engine[0]/yaw-angle-rad</output>
		</scheduled_gain>		
		
	<!-- Pitch Adjust -->

		<summer>
			<input>T4T/AGP/PID/cyclic/pitch_adjust</input>
			<input>T4T/AGP/PID/cyclic/pitch_trim-hold</input>
			<clipto>											
				<min>-1</min>									
				<max>1</max>									
			</clipto>
			<output>T4T/AGP/PID/cyclic/pitch_target</output>														
		</summer>

		<switch name="T4T/AGP/PID/cyclic/pitch_trim-hold">
			<default value="T4T/AGP/PID/cyclic/pitch_trim-hold"/>
			<test value="T4T/AGP/PID/cyclic/pitch_target">
				T4T/AGP/trim eq 1
			</test>
		</switch>
		<switch>
			<default value="T4T/AGP/trim"/>
			<test value="0">
				T4T/AGP/trim eq 1
			</test>
			<output>T4T/AGP/trim</output>			
		</switch>		
	
		<scheduled_gain>
			<input>T4T/one</input>
			<table>
				<independentVar>T4T/AGP/PID/cyclic/pitch_target</independentVar>
				<tableData>
					-1		-30
					1		30
				</tableData>
			</table>
			<output>external_reactions/rotor_main/cyclic_pitch-in</output>
		</scheduled_gain>
			
		<fcs_function>
			<function>
				<sum>
					<table>
						<independentVar>external_reactions/rotor_main/cyclic_pitch-in</independentVar>
						<tableData>
							-30		0.2618 	<!-- 15 degs -->
							30		-0.2618	<!-- -15 degs -->
						</tableData>
					</table>
					<value>1.483529864</value>
				</sum>
			</function>
			<output>propulsion/engine[0]/pitch-angle-rad</output>			
		</fcs_function>		

		<fcs_function>
			<function>
					<sum>
						<table>
							<independentVar>external_reactions/rotor_main/cyclic_pitch-in</independentVar>
							<tableData>
								-10		-0.261799 	<!-- 15 degs -->
								10		0.261799	<!-- -15 degs -->
							</tableData>
						</table>
						<value>-0.0524</value> <!-- installation rigging angle of -3 degs-->
					</sum>
			</function>
			<output>T4T/aero/h-tail/rigging-rad</output>
		</fcs_function>	

		<fcs_function>
			<function>
				<todegrees>
					<property>T4T/aero/h-tail/rigging-rad</property>
				</todegrees>
			</function>
			<output>T4T/aero/h-tail/rigging-deg</output>			
		</fcs_function>			

	<!-- Yaw Adjust -->
		
		<fcs_function name="propulsion/rudder-with-roll_adjust">
			<function>																			
				<product>																									
					<table>
						<independentVar>propulsion/rotor_rudder_adjust</independentVar>							
						<tableData>
								0.7		0.0
								1.0		1.0
								1.3		0.0						
						</tableData>
					</table>
					<table>																						
						<independentVar lookup="row">attitude/roll-rad</independentVar>																						
						<independentVar lookup="column">velocities/u-fps</independentVar>																						
						<tableData>
										10		50
								-1		0		-0.3
								0		0		0.0
								1		0		0.3								
						</tableData>
					</table>					
				</product>																									
			</function>
			<output>propulsion/rudder-with-roll_adjust</output>			
		</fcs_function>		
	
	<!-- Roll Damping -->

		<fcs_function>
			<function>
				<quotient>
					<sum>
						<property>moments/l-prop-lbsft</property>					
						<property>moments/l-tail_rotor-lbsft</property>							
					</sum>
					<property>external_reactions/rotor_main/z</property>				
				</quotient>
			</function>
			<output>external_reactions/rotor_main/damping_l-precession-ft</output>
		</fcs_function>
		
		<pure_gain>
			<input>external_reactions/rotor_main/damping_l-precession-ft</input>
			<gain>-12</gain>
			<output>external_reactions/rotor_main/damping_l-precession-in</output>
		</pure_gain>
		
		<pure_gain>
			<input>velocities/p-rad_sec</input>
			<gain>40</gain>
			<output>external_reactions/rotor_main/damping_p-rad_sec-in</output>
		</pure_gain>		
			
	<!-- Pitch Damping -->
	
		<fcs_function>
			<function>
				<product>
					<value>-12</value>
					<quotient>
						<property>moments/m-prop-lbsft</property>
						<property>external_reactions/rotor_main/z</property>					
					</quotient>
				</product>
			</function>
			<output>external_reactions/rotor_main/damping_m-precession-in</output>
		</fcs_function>
		
		<pure_gain>
			<input>velocities/q-rad_sec</input>
			<gain>20</gain>
			<output>external_reactions/rotor_main/damping_q-rad_sec-in</output>
		</pure_gain>		

	<!-- Yaw Damping -->
	
		<scheduled_gain>
			<input>T4T/one</input>
			<table>
				<independentVar>velocities/r-rad_sec</independentVar>
				<tableData>
					-1		-0.8
					1		0.8
				</tableData>
			</table>
			<output>external_reactions/rotor_tail/damping_r-rad_sec</output>
		</scheduled_gain>		
		
	<!-- Roll -->	

		<summer>
			<input>inertia/cg-y-in</input>
			<input>external_reactions/rotor_main/damping_l-precession-in</input>
			<input>external_reactions/rotor_main/cyclic_roll-in</input>
 			<input>external_reactions/rotor_main/damping_p-rad_sec-in</input>			
			<clipto>														
				<min>-100</min> <!-- to the right  -->													
				<max>100</max> <!-- to the left  -->													
			</clipto>														
			<output>external_reactions/rotor_main/location-y-in</output>														
		</summer>		

	<!-- Pitch -->
		
		<summer>
			<input>inertia/cg-x-in</input>
			<input>external_reactions/rotor_main/damping_m-precession-in</input>
			<input>external_reactions/rotor_main/cyclic_pitch-in</input>		
 			<input>external_reactions/rotor_main/damping_q-rad_sec-in</input>			
			<clipto>											
				<min>-110</min> <!-- forward  -->										
				<max>291</max> <!-- backward  -->										
			</clipto>											
			<output>external_reactions/rotor_main/location-x-in</output>
		</summer>

	<!-- Yaw -->

		<summer>
			<input>propulsion/rotor_rudder_adjust</input>
			<input>propulsion/rudder-with-roll_adjust</input>			
			<input>external_reactions/rotor_tail/damping_r-rad_sec</input>
			<output>external_reactions/rotor_tail/power_adjust</output>
		</summer>

</channel>

</system>